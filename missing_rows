import pandas as pd

# Load the two tables into DataFrames
table_1 = pd.read_csv(r'C:\Users\asus\OneDrive\Desktop\store_sales2.csv')
table_2 = pd.read_csv(r'C:\Users\asus\OneDrive\Desktop\store_sales3.csv')

# Specify the primary key column names
primary_key = ['key','date']  # Adjust as needed

# Ensure the primary key is in both tables
for pk in primary_key:
    if pk not in table_1.columns or pk not in table_2.columns:
        raise ValueError(f"Primary key '{pk}' is missing from one of the tables.")

# Sort and set the primary key as index
table_1 = table_1.sort_values(by=primary_key).set_index(primary_key)
table_2 = table_2.sort_values(by=primary_key).set_index(primary_key)

# Get user choice for level of detail
print("Do you want to print all differences or just a summary?")
user_choice = input("Enter 'all' or 'summary': ").lower()

# Find common columns between the two tables
common_columns = set(table_1.columns) & set(table_2.columns)

# Identify missing rows between the two tables
merged = table_1.merge(table_2, how='outer', on=primary_key, indicator=True)

missing_rows_table_1 = merged[merged['_merge'] == 'right_only']
missing_rows_table_2 = merged[merged['_merge'] == 'left_only']

# Check for column differences
column_diff_counts = {}

if user_choice == 'all':
    # Check for row-level differences in common columns
    for column in common_columns:
        if not table_1.index.equals(table_2.index):
            # Ensure indices are consistent before comparison
            table_1 = table_1.reindex(table_2.index)

        differences = table_1[column] != table_2[column]
        different_rows = table_1[differences]

        if not different_rows.empty:
            column_diff_counts[column] = len(different_rows)
            print(f"Differences in column '{column}':")

            for idx, row in different_rows.iterrows():
                corresponding_row = table_2.loc[idx]
                table_2_value = corresponding_row[column] if not corresponding_row.empty else 'N/A'

                print(f"  - Primary Key: {idx}")
                print(f"    Table_1: {row[column]}")
                print(f"    Table_2: {table_2_value}")

    # Print missing rows if any
    if not missing_rows_table_1.empty:
        print("Rows missing in Table_1:")
        if primary_key[0] in missing_rows_table_1.columns:
            print(missing_rows_table_1[primary_key])
        else:
            print("Primary key information not found. Here are the first few rows:")
            print(missing_rows_table_1.head())

    if not missing_rows_table_2.empty:
        print("Rows missing in Table_2:")
        if primary_key[0] in missing_rows_table_2.columns:
            print(missing_rows_table_2[primary_key])
        else:
            print("Please see below missing Primary keys. Here are the first few rows:")
            print(missing_rows_table_2.head())

elif user_choice == 'summary':
    # Summary information for differences in common columns
    if not column_diff_counts:
        print("No differences found in common columns.")
    
    if not missing_rows_table_1.empty or not missing_rows_table_2.empty:
        print("Missing Rows Summary:")
        if not missing_rows_table_1.empty:
            print("Table_1 is missing rows.")
        if not missing_rows_table_2.empty:
            print("Table_2 is missing rows.")

        # Summary of differences in common columns
        if column_diff_counts:
            print("Column Differences Summary:")
            for column, diff_count in column_diff_counts.items():
                print(f"  - {column}: {diff_count} differences")
