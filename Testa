WITH latest_actual AS (
    SELECT 
        a.msr_id,
        a.report_period_start_date,
        a.distinct_ref,
        a.actual_value,
        COUNT(*) OVER (PARTITION BY a.msr_id, a.report_period_start_date) AS cnt,
        ROW_NUMBER() OVER (PARTITION BY a.msr_id, a.report_period_start_date ORDER BY a.load_timestamp DESC) AS rn
    FROM 
        schema_name.table_actual a
    WHERE 
        a.report_period_start_date <= (
            SELECT MAX(report_period_start_date) 
            FROM schema_name.table_actual b 
            WHERE a.msr_id = b.msr_id
        )
),
latest_prev AS (
    SELECT 
        msr_id, 
        report_period_start_date, 
        actual_value AS prev_value,
        COUNT(*) OVER (PARTITION BY msr_id, report_period_start_date) AS cnt,
        ROW_NUMBER() OVER (PARTITION BY msr_id, report_period_start_date ORDER BY load_timestamp DESC) AS rn
    FROM 
        schema_name.table_prev 
)
SELECT 
    act.msr_id,
    act.report_period_start_date,
    CASE 
        WHEN act.actual_value IS NULL THEN NULL 
        ELSE 'TREND' 
    END AS report_type,
    act.actual_value AS fact_value,
    CASE 
        WHEN prev.cnt > 1 THEN prev.prev_value  -- if more than one prev_value, get the latest
        WHEN prev.cnt = 1 THEN prev.prev_value  -- if only one, get that value
        ELSE NULL
    END AS fact_prev_value,
    amb.ambition_value,
    frc.forecast_value 
FROM 
    latest_actual act
LEFT JOIN (
    SELECT 
        distinct_ref, 
        ambition_value 
    FROM 
        schema_name.table_ambition 
    QUALIFY ROW_NUMBER() OVER (PARTITION BY distinct_ref ORDER BY load_timestamp DESC) = 1
) amb ON act.distinct_ref = amb.distinct_ref 
LEFT JOIN (
    SELECT 
        distinct_ref, 
        forecast_value 
    FROM 
        schema_name.table_forecast 
    QUALIFY ROW_NUMBER() OVER (PARTITION BY distinct_ref ORDER BY load_timestamp DESC) = 1
) frc ON act.distinct_ref = frc.distinct_ref
LEFT JOIN latest_prev prev ON act.msr_id = prev.msr_id 
    AND act.report_period_start_date = prev.report_period_start_date 
WHERE 
    (act.cnt = 1 OR act.rn = 1)  -- Fetch only if count is 1 or the latest
GROUP BY 
    act.msr_id, 
    act.report_period_start_date, 
    report_type, 
    act.actual_value, 
    prev.prev_value, 
    amb.ambition_value, 
    frc.forecast_value;
